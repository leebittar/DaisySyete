<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARTA CSS Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the dark sidebar and content area */
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }
        @media (max-width: 768px) {
            #sidebar {
                position: fixed;
                z-index: 50;
                height: 100%;
                transform: translateX(-100%);
            }
            #sidebar.open {
                transform: translateX(0);
            }
        }
        /* Custom scrollbar for better visual appeal */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        /* Style for the colored table cells in Raw Responses */
        .score-cell {
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 600;
            text-align: center;
        }
        .score-5 { background-color: #d1fae5; color: #065f46; } /* Green */
        .score-4 { background-color: #fef3c7; color: #b45309; } /* Yellow-Orange */
        .status-active { background-color: #d1fae5; color: #065f46; padding: 2px 8px; border-radius: 9999px; font-weight: 500; }
        .status-pending { background-color: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 9999px; font-weight: 500; }

    </style>
    <!-- Libraries for data export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>    </style>
</head>
<body class="font-sans bg-gray-50 antialiased" style="min-height: 100vh;">

    <div id="app" class="min-h-screen">
        <div id="loginView" class="hidden">
            <div class="flex flex-col md:flex-row min-h-screen">
                <div class="md:w-1/2 flex flex-col justify-between p-10 bg-cover bg-center text-white" 
                     style="background-image: url('https://placehold.co/1200x800/22408D/ffffff?text=Valenzuela+City+Hall+Plaza');">
                    <h1 class="4xl font-extrabold mb-4 md:mb-0 drop-shadow-lg">ARTA CSS System</h1>
                    <div class="my-auto text-center">
                        <div class="mx-auto w-32 h-32 md:w-48 md:h-48 rounded-full border-4 border-white flex items-center justify-center bg-transparent backdrop-blur-sm">
                            <svg class="w-2/3 h-2/3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.248a12.023 12.023 0 014.248 10.248a12.023 12.023 0 01-10.248 4.248c-3.131-.837-5.908-2.67-7.908-5.07c-2.062-2.4-3.166-5.46-3.166-8.73c0-1.8.318-3.56.918-5.212z"></path></svg>
                        </div>
                    </div>
                    <p class="text-sm text-center drop-shadow-lg">Authorized personnel only. All access is monitored.</p>
                </div>

                <div class="md:w-1/2 flex items-center justify-center p-8 md:p-16 bg-white">
                    <div class="w-full max-w-md">
                        <h2 class="text-5xl font-extrabold text-gray-800 mb-10 text-center">Log In</h2>
                        <form id="loginForm" class="space-y-6">
                            <div>
                                <label for="email" class="block text-lg font-medium text-gray-700">Email:</label>
                                <div class="mt-2 relative rounded-xl shadow-md">
                                    <input type="email" id="email" name="email" required placeholder="e.g. juan_delacruz@gmail.com"
                                           class="w-full px-5 py-3 border-2 border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 text-gray-900 pr-12">
                                    <span class="absolute right-0 top-0 mt-3 mr-4 text-gray-400">
                                        <i data-lucide="mail" class="w-5 h-5"></i>
                                    </span>
                                </div>
                            </div>
                            <div>
                                <label for="password" class="block text-lg font-medium text-gray-700">Password:</label>
                                <div class="mt-2 relative rounded-xl shadow-md">
                                    <input type="password" id="password" name="password" required
                                           class="w-full px-5 py-3 border-2 border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 text-gray-900 pr-12">
                                    <span class="absolute right-0 top-0 mt-3 mr-4 text-gray-400">
                                        <i data-lucide="lock" class="w-5 h-5"></i>
                                    </span>
                                </div>
                                <div class="text-sm mt-2 text-right">
                                    <a href="#" class="text-sm font-medium text-blue-600 hover:text-blue-500">
                                        Forgot password?
                                    </a>
                                </div>
                            </div>
                            <div id="loginError" class="text-red-600 text-center hidden">Invalid email or password.</div>
                            <div class="pt-4">
                                <button type="submit"
                                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-xl shadow-xl text-lg font-medium text-white bg-gray-800 hover:bg-gray-900 focus:outline-none focus:ring-4 focus:ring-gray-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                                    Log In
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboardView" class="hidden min-h-screen flex flex-col">
            <header class="flex items-center justify-between p-4 bg-white shadow-md z-40 fixed w-full top-0">
                <div class="flex items-center space-x-4">
                    <button id="menu-toggle" class="md:hidden p-2 text-gray-600 hover:text-gray-900 rounded-full hover:bg-gray-100">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                    <div class="flex items-center justify-center flex-shrink-0">
                        <img src="Admin Side/Nav Admin/footerlogo.png" alt="" class="w-12 h-12 object-contain"> 
                    </div>
                    
                    <div class="hidden sm:block flex items-center justify-center flex-shrink-0">
                         <img src="Admin Side/Nav Admin/text.png" alt="" class="w-32 h-12 object-contain"> 
                    </div>
                    <h1 class="text-xl font-semibold text-gray-800 hidden md:block">ARTA Customer Satisfaction Survey Dashboard</h1>
                </div>
                <div class="flex items-center space-x-2 cursor-pointer p-2 rounded-xl bg-blue-50 hover:bg-blue-100 transition duration-150">
                    <div class="w-10 h-10 p-2 rounded-full flex-shrink-0">
                         <img src="Admin Side/Nav Admin/admin.png" alt="" class="w-full h-full object-contain">
                    </div>
                    <span class="hidden sm:inline font-medium text-gray-700">Admin</span>
                    <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500"></i>
                    </div>
            </header>

            <div class="flex flex-grow pt-20">
                <aside id="sidebar" class="bg-[#0b296b] pt-4 text-white w-64 md:w-64 flex-shrink-0 md:relative md:translate-x-0">
                    <div class="p-6">
                        <h2 class="text-xl font-bold mb-1">ARTA CSS</h2>
                        <p class="text-sm opacity-75">CONTROL CENTER</p>
                    </div>
                    <nav class="space-y-1 p-3">
                        <a href="#" data-view="dashboard" class="nav-link flex items-center p-3 rounded-xl transition duration-150 ease-in-out bg-white text-[#0b296b] shadow-lg">
                            <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>
                            Dashboard
                        </a>
                        <a href="#" data-view="raw-responses" class="nav-link flex items-center p-3 rounded-xl transition duration-150 ease-in-out hover:bg-[#1f3f80] text-gray-200">
                            <i data-lucide="database" class="w-5 h-5 mr-3"></i>
                            Raw Responses
                        </a>
                        <a href="#" data-view="compliance-reports" class="nav-link flex items-center p-3 rounded-xl transition duration-150 ease-in-out hover:bg-[#1f3f80] text-gray-200">
                            <i data-lucide="file-text" class="w-5 h-5 mr-3"></i>
                            Compliance Reports
                        </a>
                        <a href="#" data-view="manage-questions" class="nav-link flex items-center p-3 rounded-xl transition duration-150 ease-in-out hover:bg-[#1f3f80] text-gray-200">
                            <i data-lucide="clipboard-list" class="w-5 h-5 mr-3"></i>
                            Manage Questions
                        </a>
                        <a href="#" data-view="user-management" class="nav-link flex items-center p-3 rounded-xl transition duration-150 ease-in-out hover:bg-[#1f3f80] text-gray-200">
                            <i data-lucide="user-cog" class="w-5 h-5 mr-3"></i>
                            User Management
                        </a>
                        <a href="#" data-view="system-settings" class="nav-link flex items-center p-3 rounded-xl transition duration-150 ease-in-out hover:bg-[#1f3f80] text-gray-200">
                            <i data-lucide="settings" class="w-5 h-5 mr-3"></i>
                            System Settings
                        </a>
                    </nav>
                </aside>

                <main id="content-area" class="flex-grow p-4 md:p-8 overflow-y-auto bg-gray-50 pt-4">
                    <div id="dashboard" class="page-content hidden">
                        <div class="mb-8">
                            <h2 class="text-3xl font-extrabold text-gray-900">System Analytics Overview</h2>
                            <p class="text-gray-500 mt-1">Welcome to the ARTA Customer Satisfaction Survey Admin Dashboard for Valenzuela City.</p>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-red-500">
                                <p class="text-lg font-medium text-gray-500">TOTAL RESPONSES</p>
                                <div class="flex items-center justify-between mt-1">
                                    <h3 id="totalResponses" class="text-2xl font-extrabold text-gray-800">0</h3>
                                    <div class="p-3 bg-red-100 text-red-600 rounded-full">
                                        <i data-lucide="file-bar-chart-2" class="w-6 h-6"></i>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-400 mt-2">Real-time Response Count from Firestore</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-yellow-500">
                                <p class="text-lg font-medium text-gray-500">AVG SATISFACTION</p>
                                <div class="flex items-center justify-between mt-1">
                                    <h3 id="avgSatisfaction" class="text-2xl font-extrabold text-gray-800">0.0 / 5</h3>
                                    <div class="p-3 bg-yellow-100 text-yellow-600 rounded-full">
                                        <i data-lucide="star" class="w-6 h-6"></i>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-400 mt-2">Average SQD rating across all submissions</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
                                <p class="text-lg font-medium text-gray-500">MOST AVAILED SERVICE</p>
                                <div class="mt-1">
                                    <h3 id="mostAvailedService" class="text-2xl font-bold text-gray-900">No data</h3>
                                </div>
                                <p class="text-sm text-gray-400 mt-2">Most frequently selected service</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500">
                                <p class="text-lg font-medium text-gray-500">CLIENT TYPE</p>
                                <div class="flex items-center justify-between mt-1">
                                    <h3 id="clientTypeSummary" class="text-2xl font-extrabold text-gray-900">—</h3>
                                    <div class="p-3 bg-blue-100 text-blue-600 rounded-full">
                                        <i data-lucide="users" class="w-6 h-6"></i>
                                    </div>
                                </div>
                                <p id="clientTypeSub" class="text-sm text-gray-400 mt-2">Distribution: Citizen / Business / Government</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-xl shadow-lg">
                                <div class="flex items-center mb-4 text-blue-800">
                                    <i data-lucide="trending-up" class="w-6 h-6 mr-2"></i>
                                    <h4 class="text-lg font-bold">Average Rating per Service (Metric 1)</h4>
                                </div>
                                <p class="text-sm text-gray-500 mb-4">Service Quality Performance Metrics Using ARTA SQD Scores.</p>
                                <div class="h-80">
                                    <canvas id="serviceChart"></canvas>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg">
                                <div class="flex items-center mb-4 text-blue-800">
                                    <i data-lucide="pie-chart" class="w-6 h-6 mr-2"></i>
                                    <h4 class="text-lg font-bold">Client Type Distribution (Metric 2)</h4>
                                </div>
                                <p class="text-sm text-gray-500 mb-4">Survey Respondent Breakdown for Data Segmentation</p>
                                <div class="h-80 flex items-center justify-center">
                                    <canvas id="clientTypeChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="raw-responses" class="page-content hidden">
                        <h2 class="text-3xl font-extrabold text-gray-900">Raw Response Data</h2>
                        <p class="text-gray-500 mt-1 mb-6">Includes all submissions, integrating data from survey platforms.</p>
                        
                        <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                            <button class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-xl transition duration-150 ease-in-out">
                                Filter Data
                            </button>
                        </div>

                        <div class="overflow-x-auto bg-white rounded-xl shadow-lg p-4">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DATE/TIME</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">OFFICE/LOCATION</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CLIENT/TYPE</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">SQD SCORE (Avg)</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">CITIZEN CHARTER AWARE</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <tr class="hover:bg-gray-50">
                                        <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">Loading data from Firestore...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="compliance-reports" class="page-content hidden">
                        <h2 class="text-3xl font-extrabold text-gray-900">Export & Reports</h2>
                        <p class="text-gray-500 mt-1 mb-6">Generate official ARTA compliance reports and export data for further analysis.</p>

                        <div class="bg-blue-50 p-4 rounded-xl border-l-4 border-blue-600 mb-6">
                            <p class="font-medium text-blue-800">ARTA Compliance Notice: All reports follow the official ARTA metrics required for submission.</p>
                        </div>

                        <div class="space-y-6">
                            <div class="flex items-center justify-between bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <div>
                                    <h3 class="text-lg font-bold text-gray-900">Export All Responses (CSV)</h3>
                                    <p class="text-sm text-gray-500">Download raw dataset for analysis in tools like Excel.</p>
                                </div>
                                <button id="exportAllCsvBtn" class="flex items-center bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-xl transition duration-150">
                                    <i data-lucide="download" class="w-5 h-5 mr-2"></i>
                                    Export CSV
                                </button>
                            </div>
                            <div class="flex items-center justify-between bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <div>
                                    <h3 class="text-lg font-bold text-gray-900">ARTA Compliance Report (PDF)</h3>
                                    <p class="text-sm text-gray-500">Generate official ARTA compliant report with analytics and metrics for quarterly submission.</p>
                                </div>
                                <button id="downloadPdfBtn" class="flex items-center bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-xl transition duration-150">
                                    <i data-lucide="file-text" class="w-5 h-5 mr-2"></i>
                                    Download PDF
                                </button>
                            </div>
                            <div class="flex items-center justify-between bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <div>
                                    <h3 class="text-lg font-bold text-gray-900">Generate Comprehensive ARTA Report</h3>
                                    <p class="text-sm text-gray-500">Create comprehensive ARTA submission report with all required metrics and citizen feedback analysis.</p>
                                </div>
                                <button id="generateReportBtn" class="flex items-center bg-gray-800 hover:bg-gray-900 text-white font-semibold py-2 px-4 rounded-xl transition duration-150">
                                    <i data-lucide="award" class="w-5 h-5 mr-2"></i>
                                    Generate Report
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="manage-questions" class="page-content hidden">
                        <h2 class="text-3xl font-extrabold text-gray-900">Manage Survey Questions</h2>
                        <p class="text-gray-500 mt-1 mb-6">Configure ARTA Customer Satisfaction Survey questions.</p>

                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Question List</h3>
                            <div class="flex gap-3">
                                <button id="setupQuestionsBtn" class="flex items-center bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-xl transition duration-150">
                                    <i data-lucide="download" class="w-5 h-5 mr-2"></i>
                                    Load Default Questions
                                </button>
                                <button id="addQuestionBtn" class="flex items-center bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-xl transition duration-150">
                                    <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                                    Add CGOV Question
                                </button>
                            </div>
                        </div>

                        <div id="questionsContainer" class="space-y-4">
                            <!-- Questions will be dynamically loaded here -->
                        </div>

                        <div class="bg-blue-50 p-4 rounded-xl border-l-4 border-blue-600 mt-6">
                            <p class="text-sm text-blue-800">The questions are ARTA-compliant and necessary for official reports; modifications must adhere to Anti-Red tape Authority standards.</p>
                        </div>
                    </div>

                    <div id="user-management" class="page-content hidden">
                        <h2 class="text-3xl font-extrabold text-gray-900">User Management</h2>
                        <p class="text-gray-500 mt-1 mb-6">Manage admin users and assign role-based access control (RBAC).</p>

                        <button id="showAddUserBtn" class="flex items-center bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-xl transition duration-150 mb-6">
                            <i data-lucide="user-plus" class="w-5 h-5 mr-2"></i>
                            Add User
                        </button>

                        <h3 class="text-xl font-bold text-gray-800 mb-4">Existing Users</h3>
                        
                        <div class="overflow-x-auto bg-white rounded-xl shadow-lg p-4 mb-8">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NAME</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">EMAIL</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ROLE</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">STATUS</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ACTIONS</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Jhairon Clarence</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">clarence@gmail.com</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Admin</span></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="status-active">Active</span></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                                            <button class="text-blue-600 hover:text-blue-800"><i data-lucide="square-pen" class="w-5 h-5"></i></button>
                                            <button class="text-red-600 hover:text-red-800"><i data-lucide="trash" class="w-5 h-5"></i></button>
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Admin User 2</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">admin2@arta.gov</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Admin</span></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="status-pending">Pending</span></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                                            <button class="text-blue-600 hover:text-blue-800"><i data-lucide="square-pen" class="w-5 h-5"></i></button>
                                            <button class="text-red-600 hover:text-red-800"><i data-lucide="trash" class="w-5 h-5"></i></button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <h3 class="text-xl font-bold text-gray-800 mb-4">Role Permissions</h3>
                        
                        <div class="space-y-4">
                            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
                                <h4 class="text-lg font-bold text-gray-800 mb-2">Admin</h4>
                                <p class="text-gray-600 text-sm">Full Operational Access. Includes User Management, Manage Questions, Raw Responses, and Compliance Reports. Excludes System Settings.</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-yellow-500">
                                <h4 class="text-lg font-bold text-gray-800 mb-2">Data Analyst</h4>
                                <p class="text-gray-600 text-sm">Data & Reporting Modules Only. Includes Dashboard, Raw Responses, and Compliance Reports.</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-red-500">
                                <h4 class="text-lg font-bold text-gray-800 mb-2">Survey Manager</h4>
                                <p class="text-gray-600 text-sm">Content Management Only. Primarily Manage Questions. May include access to the Dashboard for results overview.</p>
                            </div>
                        </div>
                    </div>

                    <div id="add-user-form" class="page-content hidden">
                        <div class="flex flex-col md:flex-row min-h-[calc(100vh-8rem)]"> 
                            <div class="md:w-1/2 flex flex-col justify-between p-10 bg-cover bg-center text-white rounded-xl shadow-xl" 
                                 style="background-image: url('Admin Side/Add User/city.png');">
                                <h1 class="4xl font-extrabold mb-4 md:mb-0 drop-shadow-lg">ARTA CSS System</h1>
                                <div class="my-auto text-center">
                                    <div class="mx-auto w-32 h-32 md:w-48 md:h-48 rounded-full border-4 border-white flex items-center justify-center bg-transparent backdrop-blur-sm">
                                        <img src="Admin Side/Add User/seal.png" alt="" class="w-full h-full object-contain">
                                    </div>
                                    </div>
                                <p class="text-sm text-center drop-shadow-lg">Authorized personnel only. All access is monitored.</p>
                            </div>

                            <div class="md:w-1/2 flex items-center justify-center p-8 md:p-16 bg-white rounded-xl shadow-xl md:ml-6 mt-6 md:mt-0">
                                <div class="w-full max-w-md">
                                    <h2 class="text-5xl font-extrabold text-gray-800 mb-10 text-center">Add User</h2>
                                    <form id="addUserForm" class="space-y-6">
                                        <div class="flex space-x-4">
                                            <div class="w-1/2">
                                                <label for="firstName" class="block text-lg font-medium text-gray-700">First Name:</label>
                                                <input type="text" id="firstName" name="firstName" required 
                                                       class="w-full px-5 py-3 border-2 border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 text-gray-900" 
                                                       aria-label="First Name">
                                                <p id="firstNameError" class="text-red-500 text-sm mt-1 hidden">First name is required.</p>
                                            </div>
                                            <div class="w-1/2">
                                                <label for="lastName" class="block text-lg font-medium text-gray-700">Last Name:</label>
                                                <input type="text" id="lastName" name="lastName" required 
                                                       class="w-full px-5 py-3 border-2 border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 text-gray-900"
                                                       aria-label="Last Name">
                                                <p id="lastNameError" class="text-red-500 text-sm mt-1 hidden">Last name is required.</p>
                                            </div>
                                        </div>

                                        <div>
                                            <label for="userEmail" class="block text-lg font-medium text-gray-700">Email:</label>
                                            <div class="mt-2 relative rounded-xl shadow-md">
                                                <input type="email" id="userEmail" name="userEmail" required placeholder="e.g. juandelacruz@gmail.com"
                                                       class="w-full px-5 py-3 border-2 border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 text-gray-900 pr-12">
                                                <span class="absolute right-0 top-0 mt-3 mr-4 text-gray-400">
                                                    <i data-lucide="mail" class="w-5 h-5"></i>
                                                </span>
                                            </div>
                                            <p id="emailError" class="text-red-500 text-sm mt-1 hidden">Enter a valid email address.</p>
                                        </div>

                                        <div>
                                            <label for="userRole" class="block text-lg font-medium text-gray-700">Role</label>
                                            <div class="mt-2 relative">
                                                <select id="userRole" name="userRole" required
                                                        class="w-full px-5 py-3 appearance-none border-2 border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 text-gray-900 cursor-pointer pr-12 bg-white">
                                                    <option value="" disabled selected>Select a role</option>
                                                    <option value="admin">Admin</option>
                                                    <option value="data analyst">Data Analyst</option>
                                                    <option value="survey manager">Survey Manager</option>
                                                </select>
                                                <span class="absolute right-0 top-0 mt-3 mr-4 text-gray-400 pointer-events-none">
                                                    <i data-lucide="chevron-down" class="w-5 h-5"></i>
                                                </span>
                                            </div>
                                            <p id="roleError" class="text-red-500 text-sm mt-1 hidden">Please select a role.</p>
                                        </div>

                                        <div class="pt-4">
                                            <button type="submit"
                                                    class="w-full flex justify-center py-3 px-4 border border-transparent rounded-xl shadow-xl text-lg font-medium text-white bg-gray-800 hover:bg-gray-900 focus:outline-none focus:ring-4 focus:ring-gray-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                                                Invite User
                                            </button>
                                            <p id="goBackBtn" class="text-sm mt-4 text-center text-gray-600 hover:text-blue-600 cursor-pointer">
                                                &larr; Go Back
                                            </p>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="system-settings" class="page-content hidden">
                        <h2 class="text-3xl font-extrabold text-gray-900">System Settings</h2>
                        <p class="text-gray-500 mt-1 mb-6">Update the system title and contact email. Keep platform details accurate for identification and communication purposes.</p>

                        <div class="bg-white p-8 rounded-xl shadow-lg max-w-2xl">
                            <h3 class="text-xl font-bold text-gray-800 mb-6 border-b pb-3">General Configuration</h3>
                            
                            <form>
                                <div class="mb-6">
                                    <label for="systemTitle" class="block text-lg font-medium text-gray-700 mb-2">System Title:</label>
                                    <input type="text" id="systemTitle" placeholder="e.g., ARTA CSS Valenzuela"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div class="mb-6">
                                    <label for="contactEmail" class="block text-lg font-medium text-gray-700 mb-2">Contact Email:</label>
                                    <input type="email" id="contactEmail" placeholder="e.g., arta@valenzuela.gov.ph"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <button type="submit"
                                        class="bg-gray-800 hover:bg-gray-900 text-white font-semibold py-3 px-6 rounded-xl shadow-md transition duration-150">
                                    Save Settings
                                </button>
                            </form>
                        </div>
                    </div>

                    </main>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold text-gray-900 mb-4" id="modalTitle">Confirm Action</h2>
            <p class="text-gray-600 mb-6" id="modalMessage">Are you sure you want to proceed with this action?</p>
            
            <div class="flex gap-4">
                <button id="confirmBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-xl transition duration-150">
                    Proceed
                </button>
                <button id="cancelBtn" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 px-4 rounded-xl transition duration-150">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Question Modal -->
    <div id="editQuestionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 overflow-y-auto">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 my-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Edit Question</h2>
            
            <form id="editQuestionForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Question Code</label>
                    <input type="text" id="editQuestionCode" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" readonly>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Question Text</label>
                    <textarea id="editQuestionText" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 h-24" required></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Question Type</label>
                    <select id="editQuestionType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="SQD">SQD Metric</option>
                        <option value="CC">CC Metric</option>
                    </select>
                </div>

                <div>
                    <label class="flex items-center">
                        <input type="checkbox" id="editQuestionRequired" class="w-4 h-4 text-blue-600 rounded">
                        <span class="ml-2 text-sm text-gray-700">Required Question</span>
                    </label>
                </div>

                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">
                        Save Changes
                    </button>
                    <button type="button" id="closeEditModal" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-150">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Question Modal -->
    <div id="addQuestionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 overflow-y-auto">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 my-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Add New Question</h2>
            
            <form id="addQuestionForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Question Code</label>
                    <input type="text" id="newQuestionCode" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., SDQ1, CC2" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Question Text</label>
                    <textarea id="newQuestionText" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 h-24" placeholder="Enter the question text" required></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Question Type</label>
                    <select id="newQuestionType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="SQD">SQD Metric</option>
                        <option value="CC">CC Metric</option>
                    </select>
                </div>

                <div>
                    <label class="flex items-center">
                        <input type="checkbox" id="newQuestionRequired" class="w-4 h-4 text-blue-600 rounded" checked>
                        <span class="ml-2 text-sm text-gray-700">Required Question</span>
                    </label>
                </div>

                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">
                        Add Question
                    </button>
                    <button type="button" id="closeAddModal" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-150">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="setup-survey-questions.js"></script>
    <script type="module">
        // --- Firestore Integration ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBlmbelcBvE8T-j2_bCeam5oGR7g3zhLz8",
            authDomain: "daisysyete-c9511.firebaseapp.com",
            projectId: "daisysyete-c9511",
            storageBucket: "daisysyete-c9511.firebasestorage.app",
            messagingSenderId: "84742185648",
            appId: "1:84742185648:web:05d506b26a2b725644d175",
            measurementId: "G-0H67RTVBTQ"
        };

        // Initialize Firebase
        const firebaseApp = initializeApp(firebaseConfig);
        const db = getFirestore(firebaseApp);

        // Store Firestore references globally for use in other scripts
        window.db = db;
        window.collection = collection;
        window.onSnapshot = onSnapshot;
        window.allSurveyResponses = []; // Store all responses for export functions

        // Helper function to safely update DOM elements
        function safeUpdateElement(id, value) {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = value;
            } else {
                console.warn(`Element with id '${id}' not found`);
            }
        }

        // Initialize real-time listeners with a slight delay to ensure DOM is ready
        setTimeout(() => {
            const surveyResponsesRef = collection(db, "survey_responses");

            // Listen for survey responses in real-time
            onSnapshot(surveyResponsesRef, (snapshot) => {
                const responses = [];
                snapshot.forEach((doc) => {
                    responses.push({ id: doc.id, ...doc.data() });
                });
                
                // Store responses globally for export functions
                window.allSurveyResponses = responses;
                
                console.log('Firestore data received:', responses);
                
                // Update metrics with aggregated data
                updateMetrics(responses);
                updateCharts(responses);
                updateResponsesTable(responses);
            }, (error) => {
                console.error('Firestore listener error:', error);
            });
        }, 100);

        /**
         * Aggregates response data and updates metric placeholders
         * @param {Array} responses - Array of response documents from Firestore
         */
        function updateMetrics(responses) {
            if (!responses || responses.length === 0) {
                safeUpdateElement('totalResponses', '0');
                safeUpdateElement('avgSatisfaction', '0.0 / 5');
                safeUpdateElement('mostAvailedService', 'No data');
                safeUpdateElement('clientTypeSummary', '—');
                return;
            }

            const totalResponses = responses.length;
            let totalSqdSum = 0;
            let totalSqdCount = 0;
            const serviceMap = {};
            const clientTypeCounts = { Citizen: 0, Business: 0, Government: 0 };

            responses.forEach(doc => {
                // Aggregate SQD scores from serviceQuality object
                const sq = doc.serviceQuality || {};
                Object.keys(sq).forEach(k => {
                    const v = Number(sq[k]);
                    if (!isNaN(v)) {
                        totalSqdSum += v;
                        totalSqdCount += 1;
                    }
                });

                // Track services
                const svc = (doc.serviceAvailed || 'Unknown').trim() || 'Unknown';
                if (!serviceMap[svc]) serviceMap[svc] = { count: 0 };
                serviceMap[svc].count += 1;

                // Track client types
                const ctRaw = (doc.clientType || 'Unknown').toString().toLowerCase();
                if (ctRaw.includes('citizen')) clientTypeCounts.Citizen += 1;
                else if (ctRaw.includes('business')) clientTypeCounts.Business += 1;
                else if (ctRaw.includes('government')) clientTypeCounts.Government += 1;
            });

            const avgSqd = totalSqdCount > 0 ? (totalSqdSum / totalSqdCount) : 0;
            let mostAvailed = 'No data';
            let maxCount = 0;
            Object.keys(serviceMap).forEach(svc => {
                if (serviceMap[svc].count > maxCount) {
                    maxCount = serviceMap[svc].count;
                    mostAvailed = svc;
                }
            });

            // Update metric elements
            safeUpdateElement('totalResponses', totalResponses.toString());
            safeUpdateElement('avgSatisfaction', `${avgSqd.toFixed(1)} / 5`);
            safeUpdateElement('mostAvailedService', mostAvailed);

            const total = totalResponses;
            const pct = (n) => ((n / total) * 100).toFixed(0) + '%';
            safeUpdateElement('clientTypeSummary', `Citizen ${pct(clientTypeCounts.Citizen)} • Business ${pct(clientTypeCounts.Business)} • Govt ${pct(clientTypeCounts.Government)}`);
        }

        /**
         * Updates charts with real-time response data
         * @param {Array} responses - Array of response documents from Firestore
         */
        function updateCharts(responses) {
            if (!responses || responses.length === 0) return;

            const totalResponses = responses.length;
            const serviceMap = {};
            const clientTypeCounts = { Citizen: 0, Business: 0, Government: 0 };

            responses.forEach(doc => {
                // Aggregate service SQD scores
                const svc = (doc.serviceAvailed || 'Unknown').trim() || 'Unknown';
                const sq = doc.serviceQuality || {};
                if (!serviceMap[svc]) serviceMap[svc] = { sumScore: 0, countScore: 0 };
                
                Object.keys(sq).forEach(k => {
                    const v = Number(sq[k]);
                    if (!isNaN(v)) {
                        serviceMap[svc].sumScore += v;
                        serviceMap[svc].countScore += 1;
                    }
                });

                // Aggregate client types
                const ctRaw = (doc.clientType || 'Unknown').toString().toLowerCase();
                if (ctRaw.includes('citizen')) clientTypeCounts.Citizen += 1;
                else if (ctRaw.includes('business')) clientTypeCounts.Business += 1;
                else if (ctRaw.includes('government')) clientTypeCounts.Government += 1;
            });

            // Prepare service chart data
            const serviceLabels = Object.keys(serviceMap);
            const serviceData = serviceLabels.map(svc => {
                const avg = serviceMap[svc].countScore > 0 ? (serviceMap[svc].sumScore / serviceMap[svc].countScore) : 0;
                return parseFloat(avg.toFixed(2));
            });

            // Update service chart
            if (window.serviceChartInstance) {
                window.serviceChartInstance.data.labels = serviceLabels;
                window.serviceChartInstance.data.datasets[0].data = serviceData;
                window.serviceChartInstance.update();
            }

            // Update client type chart
            if (window.clientTypeChartInstance) {
                window.clientTypeChartInstance.data.datasets[0].data = [clientTypeCounts.Citizen, clientTypeCounts.Business, clientTypeCounts.Government];
                window.clientTypeChartInstance.update();
            }
        }

        /**
         * Updates the raw responses table with real-time data
         * @param {Array} responses - Array of response documents from Firestore
         */
        function updateResponsesTable(responses) {
            const tableBody = document.querySelector('#raw-responses tbody');
            if (!tableBody) return;

            if (responses.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">No survey responses yet</td></tr>';
                return;
            }

            tableBody.innerHTML = '';
            responses.slice(0, 10).forEach((doc, index) => {
                const sq = doc.serviceQuality || {};
                let sqSum = 0, sqCount = 0;
                Object.keys(sq).forEach(k => {
                    const v = Number(sq[k]);
                    if (!isNaN(v)) { sqSum += v; sqCount += 1; }
                });
                const avgSqd = sqCount > 0 ? (sqSum / sqCount) : 0;

                const submittedAt = doc.submittedAt ? new Date(doc.submittedAt.toDate ? doc.submittedAt.toDate() : doc.submittedAt).toLocaleString() : 'N/A';
                const ctRaw = (doc.clientType || 'Unknown').toString().toLowerCase();
                const isCitizen = ctRaw.includes('citizen');
                const ccAwere = doc.citizensCharter && doc.citizensCharter.cc1 !== '4' ? 'Yes' : 'No';

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${String(index + 1).padStart(3, '0')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${submittedAt}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${doc.officeLocation || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${isCitizen ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'}">
                            ${doc.clientType || 'Unknown'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                        <span class="score-cell ${avgSqd >= 4.5 ? 'score-5' : 'score-4'}">
                            ${avgSqd.toFixed(1)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center ${ccAwere === 'Yes' ? 'text-blue-600' : 'text-red-600'} font-semibold">
                        ${ccAwere}
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Expose update functions globally for use in main script
        window.updateMetrics = updateMetrics;
        window.updateCharts = updateCharts;
        window.updateResponsesTable = updateResponsesTable;
    </script>

    <script>
        // --- Configuration ---
        const SUPER_ADMIN_EMAIL = 'super@admin.com';
        const SUPER_ADMIN_PASSWORD = 'password123';
        
        // --- Element Selection ---
        const app = document.getElementById('app');
        const loginView = document.getElementById('loginView');
        const dashboardView = document.getElementById('dashboardView');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const navLinks = document.querySelectorAll('.nav-link');
        const pageContents = document.querySelectorAll('.page-content');
        const sidebar = document.getElementById('sidebar');
        const menuToggle = document.getElementById('menu-toggle');

        const showAddUserBtn = document.getElementById('showAddUserBtn'); // NEW
        const addUserForm = document.getElementById('addUserForm'); // NEW
        const goBackBtn = document.getElementById('goBackBtn'); // NEW

        let currentView = 'dashboard';

        // --- Core Functions ---

        /**
         * Initializes Chart.js graphs for the dashboard.
         * Must be called only once or after the dashboard view is visible.
         */
        function initCharts() {
            // Check if charts are already initialized
            if (window.serviceChartInstance || window.clientTypeChartInstance) return;
            
            // Chart 1: Average Rating per Service (Horizontal Bar) - Start empty
            const serviceCtx = document.getElementById('serviceChart');
            if (serviceCtx) {
                window.serviceChartInstance = new Chart(serviceCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Average SQD Score',
                            data: [],
                            backgroundColor: '#2563EB',
                            borderRadius: 6
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: false }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                max: 5,
                                grid: { drawBorder: false },
                                ticks: { stepSize: 1 }
                            },
                            y: {
                                grid: { drawBorder: false, display: false }
                            }
                        }
                    }
                });
            }

            // Chart 2: Client Type Distribution (Doughnut) - Start empty
            const clientTypeCtx = document.getElementById('clientTypeChart');
            if (clientTypeCtx) {
                window.clientTypeChartInstance = new Chart(clientTypeCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Citizen', 'Business', 'Government'],
                        datasets: [{
                            label: 'Client Type Distribution',
                            data: [0, 0, 0],
                            backgroundColor: ['#1D4ED8', '#60A5FA', '#93C5FD']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const value = context.parsed || 0;
                                        const pct = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${context.label}: ${pct}%`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        /**
         * Handles screen navigation within the dashboard.
         * @param {string} viewId - The ID of the view to show (e.g., 'dashboard', 'raw-responses').
         */
        function navigateTo(viewId) {
            currentView = viewId;
            
            // 1. Hide all page contents
            pageContents.forEach(content => {
                content.classList.add('hidden');
            });

            // 2. Show the requested page content
            const targetContent = document.getElementById(viewId);
            if (targetContent) {
                targetContent.classList.remove('hidden');
                
                // Special case: Initialize charts on dashboard load
                if (viewId === 'dashboard') {
                    initCharts();
                }
                
                // Special case: Load questions on manage-questions load
                if (viewId === 'manage-questions') {
                    loadSurveyQuestions();
                }
            }

            // 3. Update active sidebar link state
            // Logic to handle 'add-user-form' being a sub-view of 'user-management'
            let activeLinkView = viewId === 'add-user-form' ? 'user-management' : viewId;

            navLinks.forEach(link => {
                link.classList.remove('bg-white', 'text-[#0b296b]', 'shadow-lg');
                link.classList.add('hover:bg-[#1f3f80]', 'text-gray-200');
                if (link.dataset.view === activeLinkView) {
                    link.classList.add('bg-white', 'text-[#0b296b]', 'shadow-lg');
                    link.classList.remove('hover:bg-[#1f3f80]', 'text-gray-200');
                }
            });

            // 4. Hide sidebar on mobile after navigation
            if (window.innerWidth < 768) {
                sidebar.classList.remove('open');
            }
        }
        
        /**
         * Toggles the main application view between Login and Dashboard.
         * @param {boolean} loggedIn - True to show dashboard, false to show login.
         */
        function toggleAppView(loggedIn) {
            if (loggedIn) {
                loginView.classList.add('hidden');
                dashboardView.classList.remove('hidden');
                navigateTo('dashboard'); // Default to dashboard home
            } else {
                dashboardView.classList.add('hidden');
                loginView.classList.remove('hidden');
                loginError.classList.add('hidden');
            }
            // Re-render Lucide icons after DOM manipulation
            lucide.createIcons(); 
        }

        /**
         * Clears all validation error messages for the Add User form.
         */
        function clearAddUserErrors() {
            document.getElementById('firstNameError').classList.add('hidden');
            document.getElementById('lastNameError').classList.add('hidden');
            document.getElementById('emailError').classList.add('hidden');
            document.getElementById('roleError').classList.add('hidden');
        }

        /**
         * Validates the Add User form fields.
         * @returns {boolean} True if the form is valid, false otherwise.
         */
        function validateAddUserForm() {
            clearAddUserErrors();
            let isValid = true;

            const firstName = document.getElementById('firstName');
            const lastName = document.getElementById('lastName');
            const userEmail = document.getElementById('userEmail');
            const userRole = document.getElementById('userRole');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (firstName.value.trim() === '') {
                document.getElementById('firstNameError').classList.remove('hidden');
                isValid = false;
            }

            if (lastName.value.trim() === '') {
                document.getElementById('lastNameError').classList.remove('hidden');
                isValid = false;
            }

            if (!emailRegex.test(userEmail.value) || userEmail.value.trim() === '') {
                document.getElementById('emailError').classList.remove('hidden');
                isValid = false;
            }

            if (userRole.value === '' || userRole.value === 'Select a role') { // Check for default disabled option
                document.getElementById('roleError').classList.remove('hidden');
                isValid = false;
            }

            return isValid;
        }

        /**
         * Store survey questions globally - loaded from survey.html's script.js
         */
        window.allSurveyQuestions = [];

        /**
         * Load survey questions from the global sqdQuestions array (from script.js)
         * This syncs with what users see in survey.html
         */
        /**
         * Initialize survey questions from Firestore with real-time listener
         */
        function initializeSurveyQuestionsFromFirestore() {
            const db = firebase.firestore();
            const questionsRef = db.collection('survey_questions');

            // Real-time listener for questions
            questionsRef.orderBy('order', 'asc').onSnapshot((snapshot) => {
                window.allSurveyQuestions = [];
                snapshot.forEach((doc) => {
                    window.allSurveyQuestions.push({
                        id: doc.id,
                        code: doc.data().code || '',
                        text: doc.data().text || '',
                        type: doc.data().type || 'SQD',
                        required: doc.data().required || true,
                        order: doc.data().order || 0
                    });
                });
                console.log('Questions synced from Firestore:', window.allSurveyQuestions.length);
                // Refresh UI if manage-questions tab is active
                if (document.getElementById('manage-questions') && !document.getElementById('manage-questions').classList.contains('hidden')) {
                    loadSurveyQuestions();
                }
            }, (error) => {
                console.error('Error loading questions:', error);
            });
        }

        /**
         * Initialize default questions to Firestore (first time setup)
         */
        async function loadDefaultQuestionsToFirestore() {
            const db = firebase.firestore();
            const questionsRef = db.collection('survey_questions');

            try {
                // Check if questions already exist
                const existingQuestions = await questionsRef.limit(1).get();
                if (!existingQuestions.empty) {
                    console.log('Questions already exist in Firestore');
                    return;
                }

                // Default questions
                const defaultQuestions = [
                    { code: 'SQD0', text: 'I am satisfied with the service that I availed.', type: 'SQD', required: true, order: 0 },
                    { code: 'SQD1', text: 'I spent a reasonable amount of time for my transaction.', type: 'SQD', required: true, order: 1 },
                    { code: 'SQD2', text: 'The office followed the transaction\'s requirements and steps based on the information provided.', type: 'SQD', required: true, order: 2 },
                    { code: 'SQD3', text: 'The steps (including payment) I needed to do for my transaction were easy and simple.', type: 'SQD', required: true, order: 3 },
                    { code: 'SQD4', text: 'I easily found information about my transaction from the office or its website.', type: 'SQD', required: true, order: 4 },
                    { code: 'SQD5', text: 'I paid a reasonable amount of fees for my transaction. (If service was free, mark the \'N/A\' option)', type: 'SQD', required: true, order: 5 },
                    { code: 'SQD6', text: 'I feel the office was fair to everyone, or \'walang palakasan\', during my transaction.', type: 'SQD', required: true, order: 6 },
                    { code: 'SQD7', text: 'I was treated courteously by the staff, and (if asked for help) the staff was helpful.', type: 'SQD', required: true, order: 7 },
                    { code: 'SQD8', text: 'I got what I needed from the government office, or if denied, the reason was explained to me clearly.', type: 'SQD', required: true, order: 8 },
                    { code: 'CC1', text: 'Which of the following best describes your awareness of a CC?', type: 'CC', required: true, order: 9 },
                    { code: 'CC2', text: 'If aware of the CC (answered 1–3 in CC1), would you say that the CC of this office was easy to see?', type: 'CC', required: true, order: 10 },
                    { code: 'CC3', text: 'If aware of the CC (answered 1–3 in CC1), would you say that the CC of this office was helpful?', type: 'CC', required: true, order: 11 }
                ];

                // Add all questions to Firestore
                for (const question of defaultQuestions) {
                    const docId = question.code.toLowerCase();
                    await questionsRef.doc(docId).set(question);
                }

                console.log('Default questions loaded to Firestore');
            } catch (error) {
                console.error('Error loading default questions:', error);
            }
        }

        /**
         * Load survey questions from Firestore or use defaults
         */
        function loadSurveyQuestions() {
            const questionsContainer = document.getElementById('questionsContainer');
            if (!questionsContainer) return;

            questionsContainer.innerHTML = '';

            const questions = window.allSurveyQuestions || [];

            if (questions.length === 0) {
                questionsContainer.innerHTML = '<p class="text-gray-500 text-center py-8">No questions available</p>';
                return;
            }

            questions.forEach((question, index) => {
                const typeColor = question.type === 'SQD' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800';
                const typeLabel = question.type === 'SQD' ? 'SQD METRIC' : 'CC METRIC';
                
                const questionCard = document.createElement('div');
                questionCard.className = 'bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-600 flex justify-between items-start';
                questionCard.innerHTML = `
                    <div class="flex-1">
                        <p class="font-semibold text-lg text-gray-800">${question.code}: ${question.text}</p>
                        <div class="mt-2 space-x-2">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${typeColor}">${typeLabel}</span>
                            ${question.required ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">REQUIRED</span>' : ''}
                            <button class="edit-btn text-xs font-medium text-blue-600 hover:text-blue-800 p-1 rounded-md transition duration-150" data-question-id="${question.id}">EDIT</button>
                        </div>
                    </div>
                    <button class="delete-btn text-gray-400 hover:text-red-500 transition duration-150" data-question-id="${question.id}">
                        <i data-lucide="trash-2" class="w-6 h-6"></i>
                    </button>
                `;
                questionsContainer.appendChild(questionCard);
            });

            // Re-render Lucide icons
            if (window.lucide) {
                lucide.createIcons();
            }

            // Attach event listeners to edit and delete buttons
            attachQuestionEventListeners();
        }

        /**
         * Attach event listeners to edit and delete buttons
         */
        function attachQuestionEventListeners() {
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const questionId = this.getAttribute('data-question-id');
                    openEditQuestionModal(questionId);
                });
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const questionId = this.getAttribute('data-question-id');
                    const question = window.allSurveyQuestions.find(q => q.id === questionId);
                    showConfirmationModal(
                        'Delete Question',
                        `Are you sure you want to delete "${question.code}: ${question.text}"?`,
                        () => deleteQuestion(questionId)
                    );
                });
            });
        }

        /**
         * Open edit question modal
         */
        function openEditQuestionModal(questionId) {
            const question = window.allSurveyQuestions.find(q => q.id === questionId);
            if (!question) return;

            document.getElementById('editQuestionCode').value = question.code;
            document.getElementById('editQuestionText').value = question.text;
            document.getElementById('editQuestionType').value = question.type;
            document.getElementById('editQuestionRequired').checked = question.required;

            const modal = document.getElementById('editQuestionModal');
            modal.classList.remove('hidden');

            // Store the question ID for use in save function
            modal.dataset.questionId = questionId;
        }

        /**
         * Close edit question modal
         */
        function closeEditQuestionModal() {
            document.getElementById('editQuestionModal').classList.add('hidden');
        }

        /**
         * Open add question modal
         */
        function openAddQuestionModal() {
            document.getElementById('addQuestionForm').reset();
            document.getElementById('addQuestionModal').classList.remove('hidden');
        }

        /**
         * Close add question modal
         */
        function closeAddQuestionModal() {
            document.getElementById('addQuestionModal').classList.add('hidden');
        }

        /**
         * Save edited question to Firestore
         */
        function saveEditedQuestion(event) {
            event.preventDefault();
            const modal = document.getElementById('editQuestionModal');
            const questionId = modal.dataset.questionId;
            
            const question = window.allSurveyQuestions.find(q => q.id === questionId);
            if (!question) return;

            const updatedText = document.getElementById('editQuestionText').value;
            const updatedType = document.getElementById('editQuestionType').value;
            const updatedRequired = document.getElementById('editQuestionRequired').checked;

            const db = firebase.firestore();
            db.collection('survey_questions').doc(questionId).update({
                text: updatedText,
                type: updatedType,
                required: updatedRequired
            }).then(() => {
                closeEditQuestionModal();
                alert('Question updated successfully!');
            }).catch((error) => {
                console.error('Error updating question:', error);
                alert('Error updating question: ' + error.message);
            });
        }

        /**
         * Add new question to Firestore
         */
        function addNewQuestion(event) {
            event.preventDefault();
            
            const code = document.getElementById('newQuestionCode').value.trim();
            const text = document.getElementById('newQuestionText').value.trim();
            const type = document.getElementById('newQuestionType').value;
            const required = document.getElementById('newQuestionRequired').checked;

            // Validate inputs
            if (!code || !text) {
                alert('Code and text are required!');
                return;
            }

            // Check if question code already exists
            if (window.allSurveyQuestions.some(q => q.code === code)) {
                alert('A question with this code already exists!');
                return;
            }

            const db = firebase.firestore();
            const docId = code.toLowerCase();
            const maxOrder = window.allSurveyQuestions.length > 0 
                ? Math.max(...window.allSurveyQuestions.map(q => q.order || 0)) + 1
                : window.allSurveyQuestions.length;
            
            db.collection('survey_questions').doc(docId).set({
                code: code,
                text: text,
                type: type,
                required: required,
                order: maxOrder
            }).then(() => {
                closeAddQuestionModal();
                alert('Question added successfully!');
            }).catch((error) => {
                console.error('Error adding question:', error);
                alert('Error adding question: ' + error.message);
            });
        }

        /**
         * Delete question from Firestore
         */
        function deleteQuestion(questionId) {
            const db = firebase.firestore();
            db.collection('survey_questions').doc(questionId).delete().then(() => {
                alert('Question deleted successfully!');
            }).catch((error) => {
                console.error('Error deleting question:', error);
                alert('Error deleting question: ' + error.message);
            });
        }

        /**
         * Show confirmation modal
         * @param {string} title - Modal title
         * @param {string} message - Modal message
         * @param {function} onConfirm - Callback when user confirms

         */
        function showConfirmationModal(title, message, onConfirm) {
            const modal = document.getElementById('confirmationModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const confirmBtn = document.getElementById('confirmBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            
            // Remove old event listeners
            const newConfirmBtn = confirmBtn.cloneNode(true);
            const newCancelBtn = cancelBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
            
            // Add new event listeners
            newConfirmBtn.addEventListener('click', function() {
                modal.classList.add('hidden');
                onConfirm();
            });
            
            newCancelBtn.addEventListener('click', function() {
                modal.classList.add('hidden');
            });
            
            modal.classList.remove('hidden');
        }

        /**
         * Export survey responses to CSV format using Firestore data
         */
        function exportToCSV() {
            const responses = window.allSurveyResponses || [];
            
            if (responses.length === 0) {
                alert('No survey data available to export.');
                return;
            }

            // Build CSV header
            let csvContent = 'Timestamp,Office Location,Client Type,Service Availed,SQD Score\n';

            // Add data rows from Firestore
            responses.forEach(response => {
                const sq = response.serviceQuality || {};
                let sqSum = 0, sqCount = 0;
                Object.keys(sq).forEach(k => {
                    const v = Number(sq[k]);
                    if (!isNaN(v)) { sqSum += v; sqCount += 1; }
                });
                const avgSqd = sqCount > 0 ? (sqSum / sqCount).toFixed(2) : 'N/A';

                const submittedAt = response.submittedAt ? new Date(response.submittedAt.toDate ? response.submittedAt.toDate() : response.submittedAt).toLocaleString() : 'N/A';
                const officeLocation = response.officeLocation || 'N/A';
                const clientType = response.clientType || 'Unknown';
                const serviceAvailed = response.serviceAvailed || 'N/A';

                const row = [
                    `"${submittedAt}"`,
                    `"${officeLocation}"`,
                    `"${clientType}"`,
                    `"${serviceAvailed}"`,
                    avgSqd
                ];
                csvContent += row.join(',') + '\n';
            });

            // Create and download CSV
            const encodedUri = encodeURI('data:text/csv;charset=utf-8,' + csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `survey-responses-${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        /**
         * Export ARTA Compliance Report as PDF using Firestore data
         */
        function exportToPDF() {
            const responses = window.allSurveyResponses || [];
            
            if (responses.length === 0) {
                alert('No survey data available to generate report.');
                return;
            }

            // Calculate metrics from Firestore data
            let totalSqdSum = 0, totalSqdCount = 0;
            const serviceMap = {};
            const clientTypeCounts = { Citizen: 0, Business: 0, Government: 0 };

            responses.forEach(doc => {
                const sq = doc.serviceQuality || {};
                Object.keys(sq).forEach(k => {
                    const v = Number(sq[k]);
                    if (!isNaN(v)) {
                        totalSqdSum += v;
                        totalSqdCount += 1;
                    }
                });

                const svc = (doc.serviceAvailed || 'Unknown').trim() || 'Unknown';
                if (!serviceMap[svc]) serviceMap[svc] = { count: 0 };
                serviceMap[svc].count += 1;

                const ctRaw = (doc.clientType || 'Unknown').toString().toLowerCase();
                if (ctRaw.includes('citizen')) clientTypeCounts.Citizen += 1;
                else if (ctRaw.includes('business')) clientTypeCounts.Business += 1;
                else if (ctRaw.includes('government')) clientTypeCounts.Government += 1;
            });

            const totalResponses = responses.length;
            const avgSqd = totalSqdCount > 0 ? (totalSqdSum / totalSqdCount).toFixed(1) : 0;
            let mostAvailed = 'No data';
            let maxCount = 0;
            Object.keys(serviceMap).forEach(svc => {
                if (serviceMap[svc].count > maxCount) {
                    maxCount = serviceMap[svc].count;
                    mostAvailed = svc;
                }
            });

            const total = totalResponses;
            const pct = (n) => ((n / total) * 100).toFixed(0);
            const citizenPct = pct(clientTypeCounts.Citizen);
            const businessPct = pct(clientTypeCounts.Business);
            const governmentPct = pct(clientTypeCounts.Government);

            const htmlContent = `
                <div style="font-family: Arial, sans-serif; padding: 20px;">
                    <h1 style="text-align: center; color: #0b296b;">ARTA Customer Satisfaction Survey</h1>
                    <h2 style="text-align: center; color: #2563eb;">Compliance Report</h2>
                    <p style="text-align: center; font-size: 12px; color: #666;">Generated: ${new Date().toLocaleString()}</p>
                    
                    <div style="background: #e3f2fd; padding: 10px; border-left: 4px solid #2196f3; margin: 20px 0;">
                        <strong style="color: #0b296b;">ARTA Compliance Notice:</strong> This report contains official metrics required for ARTA submission.
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <div style="margin: 15px 0; padding: 10px; border: 1px solid #ddd;">
                            <strong style="color: #0b296b;">Total Survey Responses:</strong> ${totalResponses}
                        </div>
                        <div style="margin: 15px 0; padding: 10px; border: 1px solid #ddd;">
                            <strong style="color: #0b296b;">Average Satisfaction Score (SQD):</strong> ${avgSqd} / 5
                        </div>
                        <div style="margin: 15px 0; padding: 10px; border: 1px solid #ddd;">
                            <strong style="color: #0b296b;">Most Availed Service:</strong> ${mostAvailed}
                        </div>
                        <div style="margin: 15px 0; padding: 10px; border: 1px solid #ddd;">
                            <strong style="color: #0b296b;">Client Type Distribution:</strong> Citizen ${citizenPct}% | Business ${businessPct}% | Government ${governmentPct}%
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666;">
                        <p>This report is generated automatically from the ARTA CSS System and follows official ARTA metrics.</p>
                        <p>For questions or clarifications, contact your ARTA system administrator.</p>
                    </div>
                </div>
            `;
            
            const element = document.createElement('div');
            element.innerHTML = htmlContent;
            
            const opt = {
                margin: 10,
                filename: `ARTA-Compliance-Report-${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
            };
            
            html2pdf().set(opt).from(element).save();
        }

        /**
         * Generate comprehensive ARTA submission report using Firestore data
         */
        function generateComprehensiveReport() {
            const responses = window.allSurveyResponses || [];
            
            if (responses.length === 0) {
                alert('No survey data available to generate comprehensive report.');
                return;
            }

            // Calculate all metrics from Firestore data
            let totalSqdSum = 0, totalSqdCount = 0;
            const serviceMap = {};
            const clientTypeCounts = { Citizen: 0, Business: 0, Government: 0 };

            responses.forEach(doc => {
                const sq = doc.serviceQuality || {};
                Object.keys(sq).forEach(k => {
                    const v = Number(sq[k]);
                    if (!isNaN(v)) {
                        totalSqdSum += v;
                        totalSqdCount += 1;
                    }
                });

                const svc = (doc.serviceAvailed || 'Unknown').trim() || 'Unknown';
                const sq2 = doc.serviceQuality || {};
                if (!serviceMap[svc]) serviceMap[svc] = { sumScore: 0, countScore: 0, totalCount: 0 };
                serviceMap[svc].totalCount += 1;
                
                Object.keys(sq2).forEach(k => {
                    const v = Number(sq2[k]);
                    if (!isNaN(v)) {
                        serviceMap[svc].sumScore += v;
                        serviceMap[svc].countScore += 1;
                    }
                });

                const ctRaw = (doc.clientType || 'Unknown').toString().toLowerCase();
                if (ctRaw.includes('citizen')) clientTypeCounts.Citizen += 1;
                else if (ctRaw.includes('business')) clientTypeCounts.Business += 1;
                else if (ctRaw.includes('government')) clientTypeCounts.Government += 1;
            });

            const totalResponses = responses.length;
            const avgSqd = totalSqdCount > 0 ? (totalSqdSum / totalSqdCount).toFixed(1) : 0;
            
            const total = totalResponses;
            const pct = (n) => ((n / total) * 100).toFixed(0);
            const citizenCount = clientTypeCounts.Citizen;
            const businessCount = clientTypeCounts.Business;
            const governmentCount = clientTypeCounts.Government;
            const citizenPct = pct(clientTypeCounts.Citizen);
            const businessPct = pct(clientTypeCounts.Business);
            const governmentPct = pct(clientTypeCounts.Government);

            // Build service table rows dynamically
            let serviceTableRows = '';
            let rowIndex = 0;
            Object.keys(serviceMap).forEach(svc => {
                const service = serviceMap[svc];
                const avgScore = service.countScore > 0 ? (service.sumScore / service.countScore).toFixed(1) : 0;
                const bgColor = rowIndex % 2 === 0 ? '' : 'background: #f9f9f9;';
                serviceTableRows += `<tr style="${bgColor}"><td style="padding: 10px; border-bottom: 1px solid #ddd;">${svc}</td><td style="padding: 10px; border-bottom: 1px solid #ddd;">${service.totalCount}</td><td style="padding: 10px; border-bottom: 1px solid #ddd;">${avgScore}/5</td></tr>`;
                rowIndex++;
            });

            const htmlContent = `
                <div style="font-family: 'Segoe UI', Arial, sans-serif; padding: 40px; background: white;">
                    <div style="text-align: center; border-bottom: 3px solid #0b296b; padding-bottom: 20px; margin-bottom: 30px;">
                        <h1 style="font-size: 32px; font-weight: bold; color: #0b296b; margin: 0;">ARTA Customer Satisfaction Survey</h1>
                        <h2 style="font-size: 18px; color: #2563eb; margin: 5px 0;">Comprehensive Compliance Report</h2>
                        <p style="font-size: 12px; color: #666; margin: 5px 0;">Generated: ${new Date().toLocaleString()}</p>
                    </div>

                    <div style="margin: 30px 0;">
                        <h3 style="font-size: 18px; font-weight: bold; color: #0b296b; margin-bottom: 15px; border-left: 4px solid #2563eb; padding-left: 10px;">Executive Summary</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0;">
                                <div style="font-size: 13px; color: #666; font-weight: 500;">Total Responses</div>
                                <div style="font-size: 24px; font-weight: bold; color: #0b296b; margin-top: 8px;">${totalResponses}</div>
                            </div>
                            <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0;">
                                <div style="font-size: 13px; color: #666; font-weight: 500;">Average Satisfaction (SQD)</div>
                                <div style="font-size: 24px; font-weight: bold; color: #0b296b; margin-top: 8px;">${avgSqd}/5</div>
                            </div>
                        </div>
                    </div>

                    <div style="margin: 30px 0;">
                        <h3 style="font-size: 18px; font-weight: bold; color: #0b296b; margin-bottom: 15px; border-left: 4px solid #2563eb; padding-left: 10px;">Client Type Distribution</h3>
                        <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
                            <thead>
                                <tr style="background: #0b296b; color: white;">
                                    <th style="padding: 12px; text-align: left;">Client Type</th>
                                    <th style="padding: 12px; text-align: left;">Count</th>
                                    <th style="padding: 12px; text-align: left;">Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td style="padding: 10px; border-bottom: 1px solid #ddd;">Citizen</td><td style="padding: 10px; border-bottom: 1px solid #ddd;">${citizenCount}</td><td style="padding: 10px; border-bottom: 1px solid #ddd;">${citizenPct}%</td></tr>
                                <tr style="background: #f9f9f9;"><td style="padding: 10px; border-bottom: 1px solid #ddd;">Business</td><td style="padding: 10px; border-bottom: 1px solid #ddd;">${businessCount}</td><td style="padding: 10px; border-bottom: 1px solid #ddd;">${businessPct}%</td></tr>
                                <tr><td style="padding: 10px; border-bottom: 1px solid #ddd;">Government</td><td style="padding: 10px; border-bottom: 1px solid #ddd;">${governmentCount}</td><td style="padding: 10px; border-bottom: 1px solid #ddd;">${governmentPct}%</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div style="margin: 30px 0;">
                        <h3 style="font-size: 18px; font-weight: bold; color: #0b296b; margin-bottom: 15px; border-left: 4px solid #2563eb; padding-left: 10px;">Service Performance Analysis</h3>
                        <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
                            <thead>
                                <tr style="background: #0b296b; color: white;">
                                    <th style="padding: 12px; text-align: left;">Service Name</th>
                                    <th style="padding: 12px; text-align: left;">Responses</th>
                                    <th style="padding: 12px; text-align: left;">Average SQD Score</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${serviceTableRows}
                            </tbody>
                        </table>
                    </div>

                    <div style="margin: 30px 0;">
                        <h3 style="font-size: 18px; font-weight: bold; color: #0b296b; margin-bottom: 15px; border-left: 4px solid #2563eb; padding-left: 10px;">Recommendations for Improvement</h3>
                        <div style="padding: 10px; margin: 8px 0; background: #e3f2fd; border-left: 4px solid #2196f3;">✓ Maintain high service quality standards for all services</div>
                        <div style="padding: 10px; margin: 8px 0; background: #e3f2fd; border-left: 4px solid #2196f3;">✓ Analyze low-performing services and implement improvements</div>
                        <div style="padding: 10px; margin: 8px 0; background: #e3f2fd; border-left: 4px solid #2196f3;">✓ Continue engaging with citizen feedback for service improvement</div>
                    </div>

                    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; text-align: center;">
                        <p><strong>Report Compliance Status:</strong> ARTA-Compliant</p>
                        <p>This report is automatically generated by the ARTA CSS System and meets all official ARTA submission standards.</p>
                    </div>
                </div>
            `;
            
            const element = document.createElement('div');
            element.innerHTML = htmlContent;
            
            const opt = {
                margin: 10,
                filename: `ARTA-Comprehensive-Report-${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
            };
            
            html2pdf().set(opt).from(element).save();
        }
        // Add Question Button
        const addQuestionBtn = document.getElementById('addQuestionBtn');
        if (addQuestionBtn) {
            addQuestionBtn.addEventListener('click', function() {
                openAddQuestionModal();
            });
        }

        // Setup Questions Button - Load default survey questions
        const setupQuestionsBtn = document.getElementById('setupQuestionsBtn');
        if (setupQuestionsBtn) {
            setupQuestionsBtn.addEventListener('click', function() {
                if (confirm('This will load all default ARTA survey questions into Firestore. Existing questions will be skipped. Continue?')) {
                    initializeDefaultSurveyQuestions();
                }
            });
        }

        // Edit Question Form Submission
        const editQuestionForm = document.getElementById('editQuestionForm');
        if (editQuestionForm) {
            editQuestionForm.addEventListener('submit', saveEditedQuestion);
        }

        // Close Edit Modal Button
        const closeEditModal = document.getElementById('closeEditModal');
        if (closeEditModal) {
            closeEditModal.addEventListener('click', closeEditQuestionModal);
        }

        // Add Question Form Submission
        const addQuestionForm = document.getElementById('addQuestionForm');
        if (addQuestionForm) {
            addQuestionForm.addEventListener('submit', addNewQuestion);
        }

        // Close Add Modal Button
        const closeAddModal = document.getElementById('closeAddModal');
        if (closeAddModal) {
            closeAddModal.addEventListener('click', closeAddQuestionModal);
        }

        // --- Event Listeners ---
        
        // 1. Login Form Submission
        loginForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (email === SUPER_ADMIN_EMAIL && password === SUPER_ADMIN_PASSWORD) {
                toggleAppView(true);
            } else {
                loginError.textContent = 'Invalid email or password.';
                loginError.classList.remove('hidden');
            }
        });

        // 2. Sidebar Navigation Clicks
        navLinks.forEach(link => {
            link.addEventListener('click', function(event) {
                event.preventDefault();
                const viewId = this.dataset.view;
                navigateTo(viewId);
            });
        });

        // 3. Mobile Menu Toggle
        menuToggle.addEventListener('click', function() {
            sidebar.classList.toggle('open');
        });

        // 4. NEW: Show Add User Form (from User Management)
        showAddUserBtn.addEventListener('click', function() {
            navigateTo('add-user-form');
        });

        // 5. NEW: Go Back to User Management (from Add User Form)
        goBackBtn.addEventListener('click', function() {
            navigateTo('user-management');
        });

        // 6. NEW: Add User Form Submission with Validation and Pop-up
        addUserForm.addEventListener('submit', function(event) {
            event.preventDefault();

            if (validateAddUserForm()) {
                // Mock: Successful invitation
                const firstName = document.getElementById('firstName').value.trim();
                const lastName = document.getElementById('lastName').value.trim();
                const role = document.getElementById('userRole').value;
                
                // Show a simple success alert (pop-up)
                alert(`Successfully invited user: ${firstName} ${lastName} as a ${role}.`);

                // Clear the form and errors
                addUserForm.reset();
                clearAddUserErrors();

                // Go back to the Manage Users dashboard
                navigateTo('user-management');
            }
        });

        // 7. Export CSV Button
        const exportAllCsvBtn = document.getElementById('exportAllCsvBtn');
        if (exportAllCsvBtn) {
            exportAllCsvBtn.addEventListener('click', function(event) {
                event.preventDefault();
                showConfirmationModal(
                    'Export Survey Data',
                    'This will download all survey responses as a CSV file. Do you want to proceed?',
                    exportToCSV
                );
            });
        }

        // 8. Download PDF Button
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        if (downloadPdfBtn) {
            downloadPdfBtn.addEventListener('click', function(event) {
                event.preventDefault();
                showConfirmationModal(
                    'Generate ARTA Compliance Report',
                    'This will generate the ARTA Compliance Report as a PDF. Do you want to proceed?',
                    exportToPDF
                );
            });
        }

        // 9. Generate Comprehensive Report Button
        const generateReportBtn = document.getElementById('generateReportBtn');
        if (generateReportBtn) {
            generateReportBtn.addEventListener('click', function(event) {
                event.preventDefault();
                showConfirmationModal(
                    'Generate Comprehensive ARTA Report',
                    'This will create a comprehensive ARTA submission report. Do you want to proceed?',
                    generateComprehensiveReport
                );
            });
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Show login view by default (do not bypass login)
            toggleAppView(true);
            
            // Initialize survey questions from Firestore with real-time listener
            initializeSurveyQuestionsFromFirestore();
            
            // Load default questions if Firestore is empty (first time setup)
            loadDefaultQuestionsToFirestore();
        });

        // Ensure lucide icons are created on first load for the login view
        lucide.createIcons();

    </script>
</body>
</html>